package simplechat;// This file contains material supporting section 3.7 of the textbook:// "Object Oriented Software Engineering" and is issued under the open-source// license found at www.lloseng.com import ocsf.server.AbstractServer;import ocsf.server.ConnectionToClient;import simplechat.commands.CommandsManager;import simplechat.commands.command.Command;import simplechat.commands.exceptions.CommandException;import simplechat.commands.parser.StringWalker;import java.io.IOException;/** * This class overrides some of the methods in the abstract * superclass in order to give more functionality to the server. * * @author Dr Timothy C. Lethbridge * @author Dr Robert Lagani&egrave;re * @author Fran&ccedil;ois B&eacute;langer * @author Paul Holden * @version July 2000 */public class EchoServer extends AbstractServer{    /**     * The default port to listen on.     */    public static final int DEFAULT_PORT = 5555;    /**     * Prefix to set in front of a message for it to handled as a command     */    public static final String COMMAND_PREFIX = "#";    private final CommandsManager<ConnectionToClient> commandsManager = new CommandsManager<>();    /**     * Constructs an instance of the echo server.     *     * @param port The port number to connect on.     */    public EchoServer(int port)    {        super(port);        commandsManager.registerCommand("quit", new Command.Builder<ConnectionToClient>().handle(result ->                {                    try                    {                        result.getContext().close();                    }                    catch (IOException e)                    {                        e.printStackTrace();                    }                }        ));    }    //Instance methods ************************************************    /**     * This method is responsible for the creation of     * the server instance (there is no UI in this phase).     *     * @param args [port] The port number to listen on.  Defaults to 5555     *             if no argument is entered.     */    public static void main(String[] args)    {        int port = 0; //Port to listen on        try        {            port = Integer.parseInt(args[0]); //Get port from command line        }        catch (Throwable t)        {            port = DEFAULT_PORT; //Set port to 5555        }        EchoServer sv = new EchoServer(port);        try        {            sv.listen(); //Start listening for connections        }        catch (Exception ex)        {            System.out.println("ERROR - Could not listen for clients!");        }    }    /**     * This method handles any messages received from the simplechat.client.     *     * @param msg    The message received from the simplechat.client.     * @param client The connection from which the message originated.     */    @Override    public void handleMessageFromClient    (Object msg, ConnectionToClient client)    {        String str = (String) msg;        System.out.println("Message received: " + msg + " from " + client);        // Is a command ?        if (str.startsWith(COMMAND_PREFIX))        {            StringWalker walker = new StringWalker(str);            walker.next(COMMAND_PREFIX.length());            try            {                commandsManager.handleCommandLine(walker, client);            }            catch (CommandException commandException)            {                try                {                    client.sendToClient(commandException.getMessage());                }                catch (IOException e)                {                    e.printStackTrace();                }            }        }        else        {            this.sendToAllClients(msg);        }    }    @Override    protected void serverStarted()    {        System.out.println("Server listening for connections on port " + getPort());    }    @Override    protected void serverStopped()    {        System.out.println("Server has stopped listening for connections.");    }    @Override    protected synchronized void clientDisconnected(ConnectionToClient client)    {        System.out.format("%s disconnected.\n", client.getName());    }    @Override    protected void clientConnected(ConnectionToClient client)    {        System.out.format("%s connected.\n", client.getName());    }    @Override    protected synchronized void clientException(ConnectionToClient client, Throwable exception)    {        this.clientDisconnected(client);    }}